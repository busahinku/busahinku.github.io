---
import { useTranslations, type Lang } from '../i18n/translations';
import { Sun, Moon, FileText } from '@lucide/astro';

interface Props {
  lang?: Lang;
  mobile?: boolean;
}

const { lang = 'en', mobile = false } = Astro.props;
const t = useTranslations(lang);
---

{mobile ? (
  <div class="theme-toggle-mobile">
    <button
      type="button"
      data-theme-btn="light"
      class="theme-btn-mobile"
      aria-label={t('theme.light')}
      title={t('theme.light')}
    >
      <Sun size={16} />
    </button>
    <button
      type="button"
      data-theme-btn="dark"
      class="theme-btn-mobile"
      aria-label={t('theme.dark')}
      title={t('theme.dark')}
    >
      <Moon size={16} />
    </button>
    <button
      type="button"
      data-theme-btn="paper"
      class="theme-btn-mobile"
      aria-label={t('theme.paper')}
      title={t('theme.paper')}
    >
      <FileText size={16} />
    </button>
  </div>
) : (
  <div class="theme-toggle" id="themeToggle">
    <button class="theme-trigger" id="themeTrigger" aria-expanded="false" aria-haspopup="true" aria-label="Toggle theme">
      <Sun size={16} class="icon-light" />
      <Moon size={16} class="icon-dark" />
      <FileText size={16} class="icon-paper" />
    </button>
    <div class="theme-dropdown" id="themeDropdown">
      <button
        type="button"
        data-theme-btn="light"
        class="theme-option"
        aria-label={t('theme.light')}
      >
        <Sun size={16} />
        <span>Light</span>
      </button>
      <button
        type="button"
        data-theme-btn="dark"
        class="theme-option"
        aria-label={t('theme.dark')}
      >
        <Moon size={16} />
        <span>Dark</span>
      </button>
      <button
        type="button"
        data-theme-btn="paper"
        class="theme-option"
        aria-label={t('theme.paper')}
      >
        <FileText size={16} />
        <span>Paper</span>
      </button>
    </div>
  </div>
)}

<style>
  /* Mobile inline style */
  .theme-toggle-mobile {
    display: flex;
    gap: 0.125rem;
    padding: 0.25rem;
    background-color: var(--bg-tertiary);
    border-radius: 9999px;
  }

  .theme-btn-mobile {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    padding: 0;
    border: none;
    background: transparent;
    color: var(--text-muted);
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .theme-btn-mobile:hover {
    color: var(--text-primary);
    background-color: var(--bg-secondary);
  }

  .theme-btn-mobile.active {
    color: var(--text-primary);
    background-color: var(--bg-primary);
  }

  /* Desktop dropdown style */
  .theme-toggle {
    position: relative;
  }

  .theme-trigger {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    padding: 0;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .theme-trigger:hover {
    color: var(--text-primary);
    background-color: var(--bg-tertiary);
  }

  /* Show only the current theme icon */
  .theme-trigger .icon-light,
  .theme-trigger .icon-dark,
  .theme-trigger .icon-paper {
    display: none;
  }

  :global([data-theme='light']) .theme-trigger .icon-light {
    display: block;
  }

  :global([data-theme='dark']) .theme-trigger .icon-dark {
    display: block;
  }

  :global([data-theme='paper']) .theme-trigger .icon-paper {
    display: block;
  }

  .theme-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 120px;
    padding: 0.375rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px var(--shadow);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-0.5rem);
    transition: all 0.2s ease;
    z-index: 100;
  }

  .theme-toggle.open .theme-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .theme-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-muted);
    background: transparent;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
  }

  .theme-option:hover {
    color: var(--text-primary);
    background-color: var(--bg-tertiary);
  }

  .theme-option.active {
    color: var(--text-primary);
    background-color: var(--bg-primary);
  }
</style>

<script>
  function initTheme() {
    const getThemePreference = (): string => {
      const stored = localStorage.getItem('theme');
      if (stored) return stored;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setTheme = (theme: string) => {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateButtons(theme);
    };

    const updateButtons = (theme: string) => {
      document.querySelectorAll('[data-theme-btn]').forEach((btn) => {
        const btnTheme = btn.getAttribute('data-theme-btn');
        btn.classList.toggle('active', btnTheme === theme);
      });
    };

    // Set initial theme
    const currentTheme = getThemePreference();
    setTheme(currentTheme);

    // Add click handlers for theme options
    document.querySelectorAll('[data-theme-btn]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const theme = btn.getAttribute('data-theme-btn');
        if (theme) {
          setTheme(theme);
          // Close dropdown after selection
          document.querySelectorAll('.theme-toggle.open').forEach(t => {
            t.classList.remove('open');
            t.querySelector('.theme-trigger')?.setAttribute('aria-expanded', 'false');
          });
        }
      });
    });

    // Toggle dropdown
    const toggles = document.querySelectorAll('.theme-toggle');
    toggles.forEach(toggle => {
      const trigger = toggle.querySelector('.theme-trigger');
      
      if (!trigger) return;

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = toggle.classList.contains('open');
        
        // Close all other dropdowns
        document.querySelectorAll('.theme-toggle.open').forEach(t => t.classList.remove('open'));
        document.querySelectorAll('.lang-switcher.open').forEach(s => s.classList.remove('open'));
        
        if (!isOpen) {
          toggle.classList.add('open');
          trigger.setAttribute('aria-expanded', 'true');
        } else {
          trigger.setAttribute('aria-expanded', 'false');
        }
      });
    });

    // Close on outside click
    document.addEventListener('click', () => {
      document.querySelectorAll('.theme-toggle.open').forEach(t => {
        t.classList.remove('open');
        t.querySelector('.theme-trigger')?.setAttribute('aria-expanded', 'false');
      });
    });
  }

  // Run on initial load
  initTheme();

  // Re-run on navigation (for View Transitions)
  document.addEventListener('astro:after-swap', initTheme);
</script>
