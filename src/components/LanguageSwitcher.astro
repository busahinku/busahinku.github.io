---
import { languages, type Lang } from '../i18n/translations';
import { Globe } from '@lucide/astro';

interface Props {
  currentLang: Lang;
  mobile?: boolean;
}

const { currentLang, mobile = false } = Astro.props;

// Get the current path without the language prefix
const pathname = Astro.url.pathname;
const pathWithoutLang = pathname.replace(/^\/(en|tr)/, '') || '/';
---

{mobile ? (
  <div class="lang-switcher-mobile">
    {Object.entries(languages).map(([lang, label]) => {
      const isActive = lang === currentLang;
      const href = lang === 'en' ? pathWithoutLang : `/${lang}${pathWithoutLang}`;

      return (
        <a
          href={href}
          class:list={['lang-btn-mobile', { active: isActive }]}
          aria-current={isActive ? 'page' : undefined}
        >
          {lang.toUpperCase()}
        </a>
      );
    })}
  </div>
) : (
  <div class="lang-switcher" id="langSwitcher">
    <button class="lang-trigger" id="langTrigger" aria-expanded="false" aria-haspopup="true">
      <Globe size={16} />
      <span class="current-lang">{currentLang.toUpperCase()}</span>
    </button>
    <div class="lang-dropdown" id="langDropdown">
      {Object.entries(languages).map(([lang, label]) => {
        const isActive = lang === currentLang;
        const href = lang === 'en' ? pathWithoutLang : `/${lang}${pathWithoutLang}`;

        return (
          <a
            href={href}
            class:list={['lang-option', { active: isActive }]}
            aria-current={isActive ? 'page' : undefined}
          >
            {lang.toUpperCase()}
          </a>
        );
      })}
    </div>
  </div>
)}

<style>
  /* Mobile inline style */
  .lang-switcher-mobile {
    display: flex;
    gap: 0.25rem;
    padding: 0.25rem;
    background-color: var(--bg-tertiary);
    border-radius: 0.5rem;
  }

  .lang-btn-mobile {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 0.75rem;
    height: 2rem;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    border: none;
    background: transparent;
    color: var(--text-muted);
    border-radius: 0.375rem;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .lang-btn-mobile:hover {
    color: var(--text-primary);
    background-color: var(--bg-secondary);
  }

  .lang-btn-mobile.active {
    color: var(--accent);
    background-color: var(--bg-primary);
    box-shadow: 0 1px 3px var(--shadow);
  }

  /* Desktop dropdown style */
  .lang-switcher {
    position: relative;
  }

  .lang-trigger {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .lang-trigger:hover {
    color: var(--text-primary);
    background-color: var(--bg-tertiary);
  }

  .lang-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 100%;
    padding: 0.375rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px var(--shadow);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-0.5rem);
    transition: all 0.2s ease;
    z-index: 100;
  }

  .lang-switcher.open .lang-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .lang-option {
    display: block;
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    text-decoration: none;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .lang-option:hover {
    color: var(--text-primary);
    background-color: var(--bg-tertiary);
  }

  .lang-option.active {
    color: var(--accent);
    background-color: var(--bg-primary);
  }
</style>

<script>
  function initLangSwitcher() {
    const switchers = document.querySelectorAll('.lang-switcher');
    
    switchers.forEach(switcher => {
      const trigger = switcher.querySelector('.lang-trigger');
      
      if (!trigger) return;

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = switcher.classList.contains('open');
        
        // Close all other dropdowns
        document.querySelectorAll('.lang-switcher.open').forEach(s => s.classList.remove('open'));
        document.querySelectorAll('.theme-toggle.open').forEach(t => t.classList.remove('open'));
        
        if (!isOpen) {
          switcher.classList.add('open');
          trigger.setAttribute('aria-expanded', 'true');
        } else {
          trigger.setAttribute('aria-expanded', 'false');
        }
      });
    });

    // Close on outside click
    document.addEventListener('click', () => {
      document.querySelectorAll('.lang-switcher.open').forEach(s => {
        s.classList.remove('open');
        s.querySelector('.lang-trigger')?.setAttribute('aria-expanded', 'false');
      });
    });
  }

  initLangSwitcher();
  document.addEventListener('astro:after-swap', initLangSwitcher);
</script>
